# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#     https://docs.fastlane.tools/plugins/available-plugins

default_platform(:android)

platform :android do
  desc "Build release APK"
  lane :build_apk do
    # Check environment variables
    unless ENV["SEREUS_STORE_FILE"]
      UI.error("SEREUS_STORE_FILE environment variable is not set")
      UI.error("Set this to the path of your keystore file")
      raise "Missing SEREUS_STORE_FILE"
    end

    unless ENV["SEREUS_STORE_PASSWORD"]
      UI.error("SEREUS_STORE_PASSWORD environment variable is not set")
      raise "Missing SEREUS_STORE_PASSWORD"
    end

    unless File.exist?(ENV["SEREUS_STORE_FILE"])
      UI.error("Keystore file not found at: #{ENV["SEREUS_STORE_FILE"]}")
      raise "Keystore file not found"
    end

    gradle(
      task: "assembleRelease"
    )

    apk_path = lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH] ||
               File.expand_path("../app/build/outputs/apk/release/app-release.apk")

    if File.exist?(apk_path)
      UI.important("")
      UI.important("ðŸ“± ANDROID APK CREATED SUCCESSFULLY ðŸ“±")
      UI.important("------------------------------------------")
      UI.important("APK File: #{apk_path}")
      UI.important("------------------------------------------")
    else
      UI.error("Could not find APK file at expected location: #{apk_path}")
    end
  end

  desc "Build app bundle for Play Store submission"
  lane :build_app_bundle do
    # Check environment variables
    unless ENV["SEREUS_STORE_FILE"]
      UI.error("SEREUS_STORE_FILE environment variable is not set")
      UI.error("Set this to the path of your keystore file")
      raise "Missing SEREUS_STORE_FILE"
    end

    unless ENV["SEREUS_STORE_PASSWORD"]
      UI.error("SEREUS_STORE_PASSWORD environment variable is not set")
      raise "Missing SEREUS_STORE_PASSWORD"
    end

    unless File.exist?(ENV["SEREUS_STORE_FILE"])
      UI.error("Keystore file not found at: #{ENV["SEREUS_STORE_FILE"]}")
      raise "Keystore file not found"
    end

    gradle(
      task: "bundleRelease"
    )

    # Get the AAB path
    aab_path = lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH] ||
               File.expand_path("../app/build/outputs/bundle/release/app-release.aab")

    # Check if AAB exists and display clear information
    if File.exist?(aab_path)
      UI.important("")
      UI.important("ðŸ“± ANDROID APP BUNDLE CREATED SUCCESSFULLY ðŸ“±")
      UI.important("------------------------------------------")
      UI.important("AAB File: #{aab_path}")
      UI.important("")
      UI.important("Manual Upload Instructions:")
      UI.important("1. Use Google Play Console: https://play.google.com/console/")
      UI.important("2. Go to Your app > 'Production' (or desired track)")
      UI.important("3. Create a new release and upload this bundle")
      UI.important("------------------------------------------")
    else
      UI.error("Could not find AAB file at expected location: #{aab_path}")
    end
  end
end


